---
title: "Geoducation"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
(WD <- getwd())
if (!is.null(WD)) setwd(WD)
```
\begin{center}
\textit{Antoine Drouhin, Aurélien Garret, Cécile Hu, Lucas Morel}
\end{center}
# TODO, Note/CR de Réunion avec la prof :
* décrire la base de données : taille, variable quanti ou quali (à faire pour la présentation orale)
* Ségrégation scolaire
* Idée :
  * Essayer de faire une classif sur les différents tx de réussite et les filières (pas étonné qu'en ts gros tx de réussite, qu'en L non etc,...) Essayer de voir pourquoi meilleur on est meilleur on sera et vice versa.
  * Choisir un indcateur de réussite, créer un indictauer en addtionnant les tx de réussite par lycée, puis régréssion pouvoir si dépend de la filière et de la géographie.
  * Secteur pivéé/public
  * Rural/urbain
  * Puis régréssion synthétique
  * Cherche taille des communes pour joindre


## Introduction

### Base de données

Notre de base de données à été trouvée sur le site Data.gouv. 
Nous avons croisé deux jeux de données distincts. Le premier concerne des données sur la performance des lycées en France (taux de réussite etc). Le second présente des données géographiques pour l’ensemble des établissement scolaires francais (Coordonnées GPS, etc.).

<https://www.data.gouv.fr/fr/>

Nous avons choisi cette base car elle présente une approche intéressante sur la compréhension d’un sujet qui nous concerne tous, l’éducation.
L’approche géographique des question de réussite scolaire nous a semblé être un champs suffisamment complet pour permettre l’utilisation des méthodes d’analyse vue en cours.

La base de données comporte de nombreuses données qui sont réparties sur toutes la France. Nous avons des répartitions de données par établissements, villes, départements et académies. Par ailleurs l'ensemble des bac généraux et technologique ainsi que certains bac professionnels sont représentés. 
```{r, include=FALSE}

read.csv2("geoducation-data2.csv", sep=";", header=TRUE, na.strings = "", encoding = "UTF-8")->bdd
bddEff = bdd[, c('Académie','Effectif.Présents.Total.séries')]
# Petit clean des datas (Antoine)
bddEff[is.na(bddEff)] <- 0
tableEff <- data.frame()
indiceCourant = 1
aca <- bddEff[1,"Académie"]

for(i in 1:nrow(bddEff)){
  if(aca != bddEff[i,"Académie"]){
    indiceCourant = indiceCourant + 1
    aca <- bddEff[i,"Académie"]
  } 
  if (length(rownames(tableEff)) != 0 && !is.na(tableEff[indiceCourant,"Académie"]) && bddEff[i,"Académie"] == tableEff[indiceCourant,"Académie"] ){
    tableEff[indiceCourant,"Effectif"] <- tableEff[aca,"Effectif"] + bddEff[i,"Effectif.Présents.Total.séries"]
  } else {
    tableEff <- rbind(tableEff, data.frame("Académie" = aca,"Effectif" = bddEff[i,"Effectif.Présents.Total.séries"]))
  }
}
seuil <- mean(tableEff[,2])
autre = 0
tableRes <- data.frame("Académie" = character(), "Effectifs" = double(), stringsAsFactors = FALSE)
for(i in 1:length(tableEff[,'Académie'])){
  if(tableEff[i,2]< seuil){
    autre = autre + tableEff[i,'Effectif']
  }
  else {
    tableRes[i,'Académie'] <- as.character(tableEff[i,"Académie"])
    tableRes[i,2] <- tableEff[i,2]
  }
}
tableRes[length(tableRes[,"Académie"])+1,"Académie"]="Autre"
tableRes[length(tableRes[,"Académie"]),"Effectifs"]=autre
tableRes<-tableRes[-which(is.na(tableRes[])),]
slices <- tableRes[,2]
lbls <- tableRes[,1]
```
```{r}
print(pie(slices, labels = lbls, main="Répartition des effectifs par académie"))
```
L'intérêt et le questionnement général porte sur la réussite scolaire de la France en fonction de la position géographique des établissements scolaires. Y’a t-il une corrélation entre la situation géographique des établissements et la réussite scolaire des étudiants ?

Plusieurs problématiques en découlent comme :

Y’a t-il des différences de réussites entre le top 10 des grandes villes en France et les villes de province ?
Paris bénéficie-t-elle d’une réussite supérieure au reste de la France ?
Quelles régions de France semble réussir mieux que les autres ?
#### Initialisation de la base de donnée

```{r}
read.csv2("geoducation-data2.csv", sep=";", header=TRUE, na.strings = "", encoding = "UTF-8")->bdd
#exists('bdd')
```

## Khi-Deux

```{r}

bddKhiDeux = bdd[, c('Académie','Effectif.Présents.série.L','Effectif.Présents.série.ES','Effectif.Présents.série.S')]
# Petit clean des datas (Antoine)
bddKhiDeux[is.na(bddKhiDeux)] <- 0

# Cette portion de code supporse que bdd est ordonné par nom d'académie. (Antoine)

tableKhiDeux <- data.frame()
indiceCourant = 1
aca <- bddKhiDeux[1,"Académie"]

for(i in 1:nrow(bddKhiDeux)){
  if(aca != bddKhiDeux[i,"Académie"]){
    indiceCourant = indiceCourant + 1
    aca <- bddKhiDeux[i,"Académie"]
  } 
  if (length(rownames(tableKhiDeux)) != 0 && !is.na(tableKhiDeux[indiceCourant,"Académie"]) && bddKhiDeux[i,"Académie"] == tableKhiDeux[indiceCourant,"Académie"] ){
    tableKhiDeux[indiceCourant,"ES"] <- tableKhiDeux[aca,"ES"] + bddKhiDeux[i,"Effectif.Présents.série.ES"]
    tableKhiDeux[indiceCourant,"L"] <- tableKhiDeux[aca,"L"] + bddKhiDeux[i,"Effectif.Présents.série.L"]
    tableKhiDeux[indiceCourant,"S"] <- tableKhiDeux[aca,"S"] + bddKhiDeux[i,"Effectif.Présents.série.S"]
  } else {
    tableKhiDeux <- rbind(tableKhiDeux, data.frame(Académie = aca,ES = bddKhiDeux[i,"Effectif.Présents.série.ES"], S = bddKhiDeux[i,"Effectif.Présents.série.S"], L = bddKhiDeux[i,"Effectif.Présents.série.L"]))
  }
}

print(tableKhiDeux)
```

On dispose ici de la table de départ pour calculer le KhiDeux. Cette table nous donne l'agrégation des effectifs par Filiaire et par Académie.

```{r}
# Calcul de la table des Abstrait
abstraitKhiDeux <- tableKhiDeux

for(i in 1:nrow(abstraitKhiDeux)){
  abstraitKhiDeux$ES[i] = sum(tableKhiDeux$ES)*sum(tableKhiDeux[i,'ES'],tableKhiDeux[i,'S'],tableKhiDeux[i,'L'])/sum(tableKhiDeux$ES,tableKhiDeux$S,tableKhiDeux$L)
  abstraitKhiDeux$S[i] = sum(tableKhiDeux$S)*sum(tableKhiDeux[i,'ES'],tableKhiDeux[i,'S'],tableKhiDeux[i,'L'])/sum(tableKhiDeux$ES,tableKhiDeux$S,tableKhiDeux$L)
  abstraitKhiDeux$L[i] = sum(tableKhiDeux$L)*sum(tableKhiDeux[i,'ES'],tableKhiDeux[i,'S'],tableKhiDeux[i,'L'])/sum(tableKhiDeux$ES,tableKhiDeux$S,tableKhiDeux$L)
}

#Calcul de la table des ecarts
ecartsKhiDeux <- tableKhiDeux

for(i in 1:nrow(abstraitKhiDeux)){
  ecartsKhiDeux$ES[i] = tableKhiDeux$ES[i] - abstraitKhiDeux$ES[i]
  ecartsKhiDeux$S[i] = tableKhiDeux$S[i] - abstraitKhiDeux$S[i]
  ecartsKhiDeux$L[i] = tableKhiDeux$L[i] - abstraitKhiDeux$L[i]
}

#Caclul de la table des contributions
contribKhiDeux <- tableKhiDeux
i=1
for(i in 1:nrow(abstraitKhiDeux)){
  contribKhiDeux$ES[i] = ecartsKhiDeux$ES[i]*ecartsKhiDeux$ES[i] / abstraitKhiDeux$ES[i]
  contribKhiDeux$S[i] = ecartsKhiDeux$S[i]*ecartsKhiDeux$S[i] / abstraitKhiDeux$S[i]
  contribKhiDeux$L[i] = ecartsKhiDeux$L[i]*ecartsKhiDeux$L[i] / abstraitKhiDeux$L[i]
}

print(contribKhiDeux)

```

Ici nous avons appliqué les étapes successives permettant de calculer le KhiDeux. Soit la corrélation entre les deux variables qualitatives : Académies et Filliaires.

Sur la table des contributions(ci-dessus) on peut observer que certaines régions et séries ont une contribution fortes a rendre dépendante ces deux variables.

On peut constater que certaines académies correspondantes a des zones géographiques périphériques ont une influance forte sur le khiDeux. Mayotte, Corse et Guadeloupe notamment. Dans ces régions la répartition entre les filières est modifiées et on trouve notamment une plus grande proportions de personnes en filiére Litéraire.

Certaines académies de métropoles ont également des comportement particulier, par exemple l'académie de Versailles a une proportion particulièrement forte de ES et faible de L. Les académies de Limoges, montpellier et Strasbourg ont également des comportement qui s'écartent des standards.

On constate finallement que la proportion de filliaire L a une forte tendance a varier alors que les filliaires ES et S ont souvent une proportions stable l'une par rapport à l'autre (environs un peux moins de deux fois plus de S que de ES). Ainsi de nombreuses académies ont une proportion de L élevée (Domtom etc..) ou faible (Lyon, Lille, Strasbourg etc..)

Finallement on calcule le score global de khideux

```{r}
khideux <- chisq.test(tableKhiDeux[,c('S','ES','L')])
print(khideux)
```

Cet indicateur nous permet de dire que la situation géograpique est certainement fortement dépendante de la répartition entre les filliaires.
En effet la probabilité que la situation géographique soit indépendante de la répartition dans les différentes filiéres est inférieure à 2.2e-16.

# Régréssion
## Est ce que le taux de réussite des èlèves en terminale S s'explique par la localisation académique ?
### Problématique

Une interrogation récurrente vis à vis de la réussite scolaire est de se demander si la situation géographique d'un étudiant tend à lui offrir des chances supplémentaire d'obtenir son baccalauréat. 

Pour essayer de déterminer si l'acadamie a un rôle prédominant dans la réussite de l'élève nous allons chercher à connaitre l'impact de l'académie sur le taux de réussite au bac S, mais nous nous interrogerons aussi sur l'influence émise par les taux de réussite au baccalauréat L. Ainsi, un environnement, crée par la jointure entre une situation géographique donnée et un taux de réussite dans une autre fillière donné, a-t-il un fort impact sur la réussite d'un éléve passant son baccalauréat scientifique ?

Ainsi, nous allons crée une matrice comportant l'académie, l'effectif présent en série scientifique, le taux brut de réussite dans cette même série et le taux dans la série L. 
```{r}
bddReg = bdd[, c('Académie','Effectif.Présents.série.S', 'Taux.Brut.de.réussite.série.S', 'Taux.Brut.de.réussite.série.L')]
```
Nous procédons ensuite au nettoyage de notre matrice en retirant les valeurs nulles et en transformant les taux à une forme 0<x<1.De plus nous retirons les valeurs aberrantes, soit celles où il n'y a pas d'éléve inscrit dans les fillières étudiées.  
```{r}
#valeur non définies mise à 0
bddReg[is.na(bddReg)] <- 0
#transformation des taux
bddReg[3] <- bddReg[3]/100
bddReg[4] <- bddReg[4]/100

df=data.frame(bddReg[1],bddReg[2],bddReg[3], bddReg[4])
#suppression des données aberrantes
df<-df[(df$Effectif.Présents.série.S>0 & df$Taux.Brut.de.réussite.série.S>0 & df$Taux.Brut.de.réussite.série.L>0),]
```
Pour mener une étude par académie nous devons agréger l'ensemble des établissements scolaire appartenant à la même académie.
```{r}
#regroupement des effectifs par académie
regData = aggregate(df$Effectif.Présents.série.S, by=list(df$Académie), FUN=sum)
#moyenne de l'ensemble des taux de réussite des lycées par académie
regData = c(regData,aggregate(df$Taux.Brut.de.réussite.série.S, by=list(df$Académie), FUN=mean)[2])
regData = c(regData,aggregate(df$Taux.Brut.de.réussite.série.L, by=list(df$Académie), FUN=mean)[2])

```
Nous créeons maitenant notre model linéaire et nous allons procéder à la regression. 
```{r}
#création du modèle 
df = data.frame(regData[1], regData[2], regData[3], regData[4])
col_headings <- c('Académie','Effectif', 'TxRéussiteS', 'TxRéussiteL')
names(df) <- col_headings
model<-lm(df$TxRéussiteS~df$Effectif+df$TxRéussiteL, data = df)
#affichage des résultats
summary(model)
```
### Analyse
On constate que la valeur de R carré est élevé impliquant que le modéle a une importance sur le taux de réussite, selon une p-value extrémement faible (5.02e-08) soit une précision de 1 sur 1 milliard. 
Cependant nous pouvons aussi observer que les deux variables utilisées n'ont pas le même impact sur notre résultat. 
En effet, l'effectif semble avoir un faible impact (-5.343e-08), tandis que le Taux de réussite en série L a un impact fort (5.170e-01).

Nous pouvons représenter l'impact de l'effectif par le nuage de point suivant, et nous constatons que la droite de la fonction de regression 
```{r}
plot(df$Effectif,df$TxRéussiteS)
x <- seq(0,18000)
lines(x,x*-5.343e-08+4.434e-01,col="red")

```

Nous pouvons représenter l'impact du taux de réussite de la série L par le nuage de points suivant, et nous constatons que la droite de la fonction de regression montre une augmentation forte. 
```{r}
plot(df$TxRéussiteL,df$TxRéussiteS)
x <- seq(0,18000)
lines(x,x*5.170e-01+4.434e-01,col="red")
```

### Conclusion 

Ainsi, selon notre étude de donnée nous pouvons affirmer que l'environnement a un impact sur la réussite d'un élève, mais ce n'est pas la localisation qui crée cette empreinte mais la réussite des paires dans une série différente est-elle un facteur déterminant. 
On peut ainsi estimer qu'un environnement où une fillière a un taux de réussite élevé impactera bénéfiquement les chances de réussite d'un élève. 

## Est ce que le taux de réussite des èlèves en terminale S s'explique par la localisation des communes ?

Nous cherchons à savoir ici su le fait qu'un étudiant inscrit au baccalauréat d'une commune a plus de chance de réussir que dans une autre commune. Nous allons regarder spécialement la série scientifique.

La première étape de ce cas de test réunie dans une nouvelle matrice, les colonnes "Ville", "Effectif.Présents.série.S" et "Taux.Brut.de.réussite.série.S". Nous allons tenter d'expliquer par la suite le taux de réussite de chaque ville par les effectifs inscrit dans ces mêmes localisations.


```{r}
bddReg = bdd[, c('Ville','Effectif.Présents.série.S', 'Taux.Brut.de.réussite.série.S')]
```

Maintenant que nous disposons des données propre à l'étude de ce cas, nous avons besoin de nettoyer les données. Il faut notemment mettre des valeurs nulles dans les champs non remplis et ramèner le taux à des valeurs comprises entre 0 et 1.

```{r}
# Permet de mettre 0 dans les cases non remplies
bddReg[is.na(bddReg)] <- 0
# Ramène le pourcentage du taux de réussite à une valeur entre 0 et 1
bddReg[3] <- bddReg[3]/100
```

Pour palier à des villes où aucun candidat ne serait inscrit dans la série S, nous supprimons volontairement ces enregistrements qui sont considérés comme des individus abérants pour notre études. C'est ce que fait la portion de code suivante.

```{r}
df=data.frame(bddReg[1],bddReg[2],bddReg[3])
df<-df[(df$Effectif.Présents.série.S>0 & df$Taux.Brut.de.réussite.série.S>0),]
```

Ce que nous allons faire maintenant, c'est faire un groupement par ville en faisant la somme des effectifs et la moyenne des taux de réussite de chaque établissement pour avoir un seul enregistrement par ville.

```{r}
regData = aggregate(df$Effectif.Présents.série.S, by=list(df$Ville), FUN=sum)
regData = c(regData,aggregate(df$Taux.Brut.de.réussite.série.S, by=list(df$Ville), FUN=mean)[2])
```

On peut donc maintenant s'apercevoir de la repartition du taux de réussite en fonction des effectifs par ville.

```{r}
df = data.frame(regData[1], regData[2], regData[3])
col_headings <- c('Ville','Effectif', 'TxRéussite')
names(df) <- col_headings
plot(df$Effectif,df$TxRéussite)
```


Nous allons donc effectuer une régréssion linéaire sur ces données pour tenter d'expliquer le taux de réussites par le lieu d'inscription du candidat au baccalauréat.
```{r}
model<-lm(df$TxRéussite~df$Effectif, data = df)
summary(model)
```


On s'aperçoit que l'effectif explique peu le taux de réussite. En effet, pour une unité du taux de réussite, l'effectif change de 2.741e-05 ce qui très petit.

Le R carré ajusté en tendant vers 0 ( adjusted R sqare = 0.005677) nous indique aussi que l'effectif explique faiblement le taux de réussite avec environ 7 chance sur 1000 de se tromper donc cette prédiction est plutot forte (p-value = 0.007613).

En traçant la droite ax + b correspondant au modèle (2.741e-05*x + 9.125e-01), on remarque sa faible pente et sa répresentation plutot horizontale ce qui indique aussi par le visuel un faible lien.

```{r}
plot(df$Effectif,df$TxRéussite)
x <- seq(0,2300)
lines(x,x*2.741e-05+9.125e-01,col="red")
```

#Conclusion Générale